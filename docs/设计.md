# 设计

## 业务需求

- 通过配置加载多个代理IP数据源，并自动装配对应的爬虫对象
- 根据抓取策略启动爬虫任务。策略主要是：抓取时间间隔
- 内部抓取到IP后，首先校验，成功后写入数据库
- 其他根据配置，生成场景IP池。不断校验场景IP池可用性，如果不可用，想上级申请。
  - 生成 http/https/socks4/socks5 通用IP池，如果通用池不可用，则重新启动抓取任务。
  - 基于通用IP池生成场景IP池，如果场景IP池不可用，则重新获取通用IP池。
- 提供 API 接口，可以获取可用的代理IP

## 业务模块

  - 抓取模块
    - 负责抓取任务
  - 校验模块
    - 负责校验和评分
    - 通用池
      - 负责对现有通用类型的IP校验可用性
      - 如果不可用，则触发抓取模块工作
    - 场景池
      - 负责对场景池中的IP，访问提供的地址，校验可用性
      - 如果不可用，则触发通用池工作
  - API模块
    - 提供对外查询服务
    - 如果没有可用IP，则触发对应池的校验工作

## 业务逻辑

### 抓取模块

首先根据配置自动装在对应的爬虫对象，然后根据配置中的时间策略，设定爬虫的抓取任务。

抓取任务根据时间策略，自动启动，加载配置中的网站地址列表和页面的解析配置，抓取并解析内容。

任务运行时，会标记运行状态，且不会能通过其他方式再次启动任务。

抓取任务解析到的数据会存入数据库，这部分的代理IP带有的属性较少，且不能保证是否可用。
所以在后面会现对该IP进行一次请求访问，如果不可用则抛弃。

### 验证模块

验证模块负验证具体场景下IP访问指定网站时的连通性，并记录验证时的信息。

场景有：

- 通用场景：即访问一般网站的连通性。最简单的方式是在公网搭建一个 nginx 服务，然后通过代理请求 nginx 首页。
    但是为了验证代理IP的匿名程度，就需要请求一个能返回实际访问IP的 Web 服务。如果服务返回的是代理IP，则说明
    使用该代理IP访问能达到高度匿名效果；如果返回本地主机IP和代理IP，则是普通匿名；如果只返回本地主机IP，
    则说明是普通代理或者说是透明代理，该代理不具备伪装价值。
- 特殊场景：所谓的特殊场景是针对特定域名去检测代理IP的连通性。

## API模块

对外提供 API 服务和管理。

## 数据模型

### 数据属性
  
    ip addr
    port
    country

### 表

ip table

| id  | ip            | country |
|-----|---------------|---------|
| 1   | 192.168.9.9   | cn      |
| 2   | 192.168.88.25 | cn      | 


proxy table

| id  | ip_fk | port | schema | protocol | anonymous | update_time      | resp_time | alive_times |
|-----|-------|------|--------|----------|-----------|------------------|-----------|-------------|
| 1   | 1     | 8080 | http   | 1        | true      | 1638328257.29217 | 2         | 10          |
| 2   | 1     | 6699 | https  | 3        | true      | 1638328257.29217 | 5         | 10          |
| 3   | 3     | 3333 | socks4 | 2        | false     | 1638328257.29217 | 1         | 2           |
| 3   | 3     | 8877 | socks5 | 3        | true      | 1638328257.29217 | 1         | 2           |

scene table

| id  | proxy_fk | name    | update_time      | resp_time | alive_times |
|-----|----------|---------|------------------|-----------|-------------|
| 2   | 1        | alibaba | 1638328257.29217 | 2         | 10          |

### redis

http

```text
http:country:cn  set
    192.168.88.88
    192.168.88.89
    
http:proxy    set
    192.168.88.88:80
    192.168.88.89:80

http:time    zset
    192.168.88.88:80   10

http:alive
    192.168.88.88:80   15

http:update_time    zset
    192.168.88.88:80   1638328257.29217

```

https

```text
https:proxy    set
    192.168.88.88:80
    192.168.88.89:80

https:time    zset
    192.168.88.88:80   10

https:alive
    192.168.88.88:80   15

https:update_time    zset
    192.168.88.88:80   1638328257.29217

```